"use strict";

var DOMException = require("domexception");

var MessageEvent = require("./generated/MessageEvent");

var _require = require("../utils"),
    isValidTargetOrigin = _require.isValidTargetOrigin;

var _require2 = require("./helpers/events"),
    fireAnEvent = _require2.fireAnEvent;

module.exports = function (message, targetOrigin) {
  var _this = this;

  if (arguments.length < 2) {
    throw new TypeError("'postMessage' requires 2 arguments: 'message' and 'targetOrigin'");
  }

  targetOrigin = String(targetOrigin);

  if (!isValidTargetOrigin(targetOrigin)) {
    throw new DOMException("Failed to execute 'postMessage' on 'Window': " + "Invalid target origin '" + targetOrigin + "' in a call to 'postMessage'.", "SyntaxError");
  } // TODO: targetOrigin === '/' - requires reference to source window
  // See https://github.com/tmpvar/jsdom/pull/1140#issuecomment-111587499


  if (targetOrigin !== "*" && targetOrigin !== this.location.origin) {
    return;
  } // TODO: event.source - requires reference to source window
  // TODO: event.origin - requires reference to source window
  // TODO: event.ports
  // TODO: event.data - structured clone message - requires cloning DOM nodes


  setTimeout(function () {
    fireAnEvent("message", _this, MessageEvent, {
      data: message
    });
  }, 0);
};