"use strict";

var exec = require('child_process').exec;

var tree = require('./tree');

var utils = require('./utils');

var hasPS = true; // discover if the OS has `ps`, and therefore can use psTree

exec('ps', function (error) {
  module.exports.hasPS = hasPS = !error;
});

module.exports = function main(pid, callback) {
  if (typeof pid === 'number') {
    pid = pid.toString();
  }

  if (hasPS && !process.env.NO_PS) {
    return tree(pid, callback);
  }

  utils.getStat().then(utils.tree).then(function (tree) {
    return utils.pidsForTree(tree, pid);
  }).then(function (res) {
    return callback(null, res.map(function (p) {
      return p.PID;
    }));
  })["catch"](function (error) {
    return callback(error);
  });
};

if (!module.parent) {
  module.exports(process.argv[2], function (e, pids) {
    return console.log(pids);
  });
}

module.exports.hasPS = hasPS;