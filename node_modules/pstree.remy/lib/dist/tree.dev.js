"use strict";

var spawn = require('child_process').spawn;

module.exports = function (rootPid, callback) {
  var pidsOfInterest = new Set([parseInt(rootPid, 10)]);
  var output = ''; // *nix

  var ps = spawn('ps', ['-A', '-o', 'ppid,pid']);
  ps.stdout.on('data', function (data) {
    output += data.toString('ascii');
  });
  ps.on('close', function () {
    try {
      var res = output.split('\n').slice(1).map(function (_) {
        return _.trim();
      }).reduce(function (acc, line) {
        var pids = line.split(/\s+/);
        var ppid = parseInt(pids[0], 10);

        if (pidsOfInterest.has(ppid)) {
          var pid = parseInt(pids[1], 10);
          acc.push(pid);
          pidsOfInterest.add(pid);
        }

        return acc;
      }, []);
      callback(null, res);
    } catch (e) {
      callback(e, null);
    }
  });
};