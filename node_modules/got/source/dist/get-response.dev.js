'use strict';

var decompressResponse = require('decompress-response');

var is = require('@sindresorhus/is');

var mimicResponse = require('mimic-response');

var progress = require('./progress');

module.exports = function (response, options, emitter) {
  var downloadBodySize = Number(response.headers['content-length']) || null;
  var progressStream = progress.download(response, emitter, downloadBodySize);
  mimicResponse(response, progressStream);
  var newResponse = options.decompress === true && is["function"](decompressResponse) && options.method !== 'HEAD' ? decompressResponse(progressStream) : progressStream;

  if (!options.decompress && ['gzip', 'deflate'].includes(response.headers['content-encoding'])) {
    options.encoding = null;
  }

  emitter.emit('response', newResponse);
  emitter.emit('downloadProgress', {
    percent: 0,
    transferred: 0,
    total: downloadBodySize
  });
  response.pipe(progressStream);
};